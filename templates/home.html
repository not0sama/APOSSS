<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Libyan Open Science - Research Repository</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@heroicons/v2/24/outline/esm/index.js"></script>
    <style>
        /* Light theme (default) */
        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #4a5568;
            --container-bg: rgba(255, 255, 255, 0.7);
            --container-border: rgba(255, 255, 255, 0.3);
            --input-bg: #ffffff;
            --input-border: #e2e8f0;
            --button-bg: rgba(255, 255, 255, 0.9);
            --button-hover: #f1f3f4;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.3);
        }

        /* Dark theme */
        [data-theme="dark"] {
            --bg-primary: #121212;
            --bg-secondary: #1a1a1a;
            --text-primary: #F8F9FA;
            --text-secondary: #a0aec0;
            --container-bg: rgba(18, 18, 18, 0.7);
            --container-border: rgba(255, 255, 255, 0.1);
            --input-bg: #1a1a1a;
            --input-border: #2d3748;
            --button-bg: rgba(18, 18, 18, 0.9);
            --button-hover: #2d3748;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --glass-bg: rgba(18, 18, 18, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            transition: background 0.3s ease;
        }
        
        .search-container {
            backdrop-filter: blur(12px) saturate(180%);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px var(--shadow-color);
            transition: all 0.3s ease;
        }
        
        .filter-btn {
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            background: var(--button-bg);
            border-color: var(--container-border);
            color: var(--text-primary);
        }
        
        .filter-btn:hover {
            transform: translateY(-2px);
            background: var(--button-hover);
            box-shadow: 0 10px 25px var(--shadow-color);
        }
        
        .filter-btn.active {
            background: #3b82f6;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.2);
        }
        
        .search-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            transition: all 0.3s ease;
        }
        
        .search-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.2);
        }

        /* Theme toggle button */
        .theme-toggle {
            background: var(--button-bg);
            border: 1px solid var(--container-border);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--button-hover);
        }

        /* Input styles */
        input, textarea, select {
            background: var(--input-bg) !important;
            border-color: var(--input-border) !important;
            color: var(--text-primary) !important;
            transition: all 0.3s ease;
        }

        input::placeholder, textarea::placeholder {
            color: var(--text-secondary) !important;
        }

        /* Text color overrides */
        .text-themed-primary { color: var(--text-primary) !important; }
        .text-themed-secondary { color: var(--text-secondary) !important; }
        .bg-themed-button { background: var(--button-bg) !important; }
        .hover-themed-button:hover { background: var(--button-hover) !important; }

        .floating-elements {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
        }
        .floating-elements::before {
            content: '';
            position: absolute;
            top: 15%;
            left: 5%;
            width: 400px;
            height: 400px;
            background: radial-gradient(
                ellipse at center,
                rgba(59, 130, 246, 0.15) 0%,
                rgba(99, 102, 241, 0.1) 30%,
                rgba(139, 92, 246, 0.05) 60%,
                rgba(139, 92, 246, 0) 100%
            );
            border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            animation: float 12s ease-in-out infinite, morph 20s ease-in-out infinite;
            filter: blur(20px);
        }
        .floating-elements::after {
            content: '';
            position: absolute;
            bottom: 10%;
            right: 5%;
            width: 500px;
            height: 500px;
            background: radial-gradient(
                ellipse at center,
                rgba(99, 102, 241, 0.15) 0%,
                rgba(139, 92, 246, 0.1) 30%,
                rgba(59, 130, 246, 0.05) 60%,
                rgba(59, 130, 246, 0) 100%
            );
            border-radius: 40% 60% 70% 30% / 40% 50% 50% 60%;
            animation: float 15s ease-in-out infinite reverse, morph 25s ease-in-out infinite;
            filter: blur(20px);
        }
        .floating-elements .element-1 {
            content: '';
            position: absolute;
            top: 30%;
            right: 15%;
            width: 300px;
            height: 300px;
            background: radial-gradient(
                ellipse at center,
                rgba(16, 185, 129, 0.1) 0%,
                rgba(5, 150, 105, 0.05) 40%,
                rgba(5, 150, 105, 0) 100%
            );
            border-radius: 50% 30% 70% 40% / 40% 60% 30% 70%;
            animation: float 18s ease-in-out infinite, morph 22s ease-in-out infinite;
            filter: blur(15px);
        }
        .floating-elements .element-2 {
            content: '';
            position: absolute;
            bottom: 25%;
            left: 20%;
            width: 250px;
            height: 250px;
            background: radial-gradient(
                ellipse at center,
                rgba(245, 158, 11, 0.08) 0%,
                rgba(234, 88, 12, 0.05) 40%,
                rgba(234, 88, 12, 0) 100%
            );
            border-radius: 30% 70% 50% 50% / 50% 30% 70% 50%;
            animation: float 14s ease-in-out infinite reverse, morph 19s ease-in-out infinite;
            filter: blur(12px);
        }
        .floating-elements .element-3 {
            content: '';
            position: absolute;
            top: 60%;
            left: 35%;
            width: 200px;
            height: 200px;
            background: radial-gradient(
                ellipse at center,
                rgba(236, 72, 153, 0.08) 0%,
                rgba(219, 39, 119, 0.05) 40%,
                rgba(219, 39, 119, 0) 100%
            );
            border-radius: 70% 30% 50% 50% / 30% 70% 50% 50%;
            animation: float 16s ease-in-out infinite, morph 21s ease-in-out infinite;
            filter: blur(10px);
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-20px) scale(1.05); }
        }
        @keyframes morph {
            0% { border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; }
            25% { border-radius: 40% 60% 70% 30% / 40% 50% 50% 60%; }
            50% { border-radius: 30% 60% 70% 40% / 50% 60% 30% 70%; }
            75% { border-radius: 60% 40% 50% 50% / 30% 60% 70% 40%; }
            100% { border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; }
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f6;
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen gradient-bg relative">
    <!-- Floating Background Elements -->
    <div class="floating-elements">
        <div class="element-1"></div>
        <div class="element-2"></div>
        <div class="element-3"></div>
    </div>
    
    <!-- Header -->
    <header class="relative z-10 bg-transparent">
        <div class="container mx-auto px-6 py-6">
            <div class="flex justify-between items-center">
                <!-- Logo -->
                <div class="flex items-center space-x-3">
                    <!-- Theme-aware SVG Logo with PNG fallback -->
                    <div class="w-10 h-10 flex items-center justify-center">
                        <img 
                            id="headerLogo"
                            src="/static/images/logo-light.svg" 
                            alt="Libyan Open Science Logo"
                            class="w-full h-full object-contain"
                            onerror="this.onerror=null; this.src='/static/images/logo.png';"
                        >
                    </div>
                    <div>
                        <h1 class="text-themed-primary text-xl font-bold">Libyan Open Science</h1>
                        <p class="text-themed-secondary text-sm">Advanced Research Search</p>
                    </div>
                </div>
                
                <!-- Authentication Buttons -->
                <div class="flex items-center space-x-4">
                    <!-- Theme Toggle Button -->
                    <button id="themeToggle" class="theme-toggle p-2 rounded-lg transition-colors">
                        <!-- Sun icon for dark mode -->
                        <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 hidden">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                        </svg>
                        <!-- Moon icon for light mode -->
                        <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                        </svg>
                    </button>
                    
                    <!-- User Info (when authenticated) -->
                    <div id="userInfo" class="flex items-center space-x-3" style="display: none;">
                        <div id="userProfile">
                            <!-- This will be populated by JavaScript when user is authenticated -->
                        </div>
                    </div>
                    
                    <!-- Login/Signup Buttons (shown when not authenticated) -->
                    <div id="authButtons" class="flex space-x-3">
                        <a href="/login" class="text-themed-secondary hover:text-blue-600 transition-colors px-4 py-2">
                            Sign In
                        </a>
                        <a href="/signup" class="bg-blue-600 text-white hover:bg-blue-700 px-6 py-2 rounded-lg transition-colors font-medium shadow-lg">
                            Sign Up
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="relative z-10 flex-1 flex items-center justify-center px-6 py-12">
        <div class="w-full max-w-4xl">
            <!-- Hero Section -->
            <div class="text-center mb-12">
                <h1 class="text-5xl md:text-6xl font-bold text-themed-primary mb-6 leading-tight">
                    A free, open-source<br>
                    <span class="text-blue-600">research repository</span>
                </h1>
                <p class="text-xl text-themed-secondary mb-8 max-w-2xl mx-auto">
                    AI-Powered Search • Powered by Experts
                </p>
            </div>

            <!-- Search Container -->
            <div class="search-container rounded-2xl p-8 shadow-2xl">
                <!-- Search Input -->
                <div class="relative mb-6">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="searchInput"
                            placeholder="Search for researches, experts, and more"
                            class="w-full px-6 py-4 pr-16 text-lg rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                        >
                        <button 
                            id="searchBtn"
                            onclick="performSearch()"
                            class="search-btn absolute right-2 top-2 bottom-2 px-6 text-white rounded-lg font-medium flex items-center"
                        >
                            <span id="searchText">Explore</span>
                            <span id="searchSpinner" class="loading ml-2 hidden"></span>
                        </button>
                    </div>
                </div>

                <!-- Filter Buttons -->
                <div class="flex flex-wrap justify-center gap-4">
                    <button 
                        class="filter-btn px-6 py-3 rounded-xl border font-medium flex items-center space-x-2 shadow-lg"
                        data-filter="experts"
                        onclick="toggleFilter(this)"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                        </svg>
                        <span>Experts</span>
                    </button>
                    
                    <button 
                        class="filter-btn px-6 py-3 rounded-xl border font-medium flex items-center space-x-2 shadow-lg"
                        data-filter="labs"
                        onclick="toggleFilter(this)"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                        <span>Labs</span>
                    </button>
                    
                    <button 
                        class="filter-btn px-6 py-3 rounded-xl border font-medium flex items-center space-x-2 shadow-lg"
                        data-filter="library"
                        onclick="toggleFilter(this)"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                        </svg>
                        <span>Library</span>
                    </button>
                    
                    <button 
                        class="filter-btn px-6 py-3 rounded-xl border font-medium flex items-center space-x-2 shadow-lg"
                        data-filter="funding"
                        onclick="toggleFilter(this)"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" />
                        </svg>
                        <span>Funding</span>
                    </button>
                    
                    <button 
                        class="filter-btn px-6 py-3 rounded-xl border font-medium flex items-center space-x-2 shadow-lg"
                        data-filter="papers"
                        onclick="toggleFilter(this)"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                        <span>Papers</span>
                    </button>
                </div>

                <!-- Quick Search Examples -->
                <div class="mt-8 text-center">
                    <p class="text-themed-secondary text-sm mb-3">Try searching for:</p>
                    <div class="flex flex-wrap justify-center gap-2">
                        <button onclick="setSearchQuery('machine learning')" class="text-blue-600 hover:text-blue-800 text-sm bg-themed-button hover-themed-button px-3 py-1 rounded-full transition-colors">
                            machine learning
                        </button>
                        <button onclick="setSearchQuery('renewable energy')" class="text-blue-600 hover:text-blue-800 text-sm bg-themed-button hover-themed-button px-3 py-1 rounded-full transition-colors">
                            renewable energy
                        </button>
                        <button onclick="setSearchQuery('medical research')" class="text-blue-600 hover:text-blue-800 text-sm bg-themed-button hover-themed-button px-3 py-1 rounded-full transition-colors">
                            medical research
                        </button>
                        <button onclick="setSearchQuery('climate change')" class="text-blue-600 hover:text-blue-800 text-sm bg-themed-button hover-themed-button px-3 py-1 rounded-full transition-colors">
                            climate change
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="relative z-10 text-center py-8">
        <div class="container mx-auto px-6">
            <p class="text-themed-secondary text-sm">
                © 2024 Libyan Open Science • 
                <a href="/dev" class="hover:text-blue-600 transition-colors">Developer Portal</a>
            </p>
        </div>
    </footer>

    <script>
        let selectedFilters = new Set();
        
        // Theme management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            const sunIcon = document.getElementById('sunIcon');
            const moonIcon = document.getElementById('moonIcon');
            const headerLogo = document.getElementById('headerLogo');
            
            if (theme === 'dark') {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
                if (headerLogo) {
                    headerLogo.src = '/static/images/logo-dark.svg';
                }
            } else {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                if (headerLogo) {
                    headerLogo.src = '/static/images/logo-light.svg';
                }
            }
            
            // Save to database if user is authenticated
            saveThemePreference(theme);
        }

        async function saveThemePreference(theme) {
            const token = localStorage.getItem('authToken');
            if (token) {
                try {
                    await fetch('/api/user/preferences', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            theme_preference: theme
                        })
                    });
                } catch (error) {
                    console.error('Error saving theme preference:', error);
                }
            }
        }

        async function loadUserThemePreference() {
            const token = localStorage.getItem('authToken');
            if (token) {
                try {
                    const response = await fetch('/api/user/preferences', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await response.json();
                    if (data.success && data.preferences.theme_preference) {
                        setTheme(data.preferences.theme_preference);
                    }
                } catch (error) {
                    console.error('Error loading theme preference:', error);
                }
            }
        }

        document.getElementById('themeToggle').addEventListener('click', function() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        });
        
        function toggleFilter(button) {
            const filter = button.dataset.filter;
            
            if (selectedFilters.has(filter)) {
                selectedFilters.delete(filter);
                button.classList.remove('active');
            } else {
                selectedFilters.add(filter);
                button.classList.add('active');
            }
        }
        
        function setSearchQuery(query) {
            document.getElementById('searchInput').value = query;
        }
        
        function showLoading(show) {
            const btn = document.getElementById('searchBtn');
            const text = document.getElementById('searchText');
            const spinner = document.getElementById('searchSpinner');
            
            if (show) {
                btn.disabled = true;
                btn.classList.add('opacity-75');
                text.textContent = 'Searching...';
                spinner.classList.remove('hidden');
            } else {
                btn.disabled = false;
                btn.classList.remove('opacity-75');
                text.textContent = 'Explore';
                spinner.classList.add('hidden');
            }
        }
        
        function showTemporaryMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv && messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 3000);
        }
        
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            
            if (!query) {
                showTemporaryMessage('Please enter a search query', 'error');
                return;
            }
            
            // Convert selected filters to database names
            const filterToDatabase = {
                'experts': 'experts_system',
                'labs': 'laboratories', 
                'library': 'academic_library',
                'funding': 'funding_system',
                'papers': 'research_papers'
            };
            
            const selectedDatabases = Array.from(selectedFilters).map(filter => filterToDatabase[filter]);
            
            showLoading(true);
            
            try {
                const searchData = {
                    query: query,
                    ranking_mode: 'hybrid',
                    database_filters: selectedDatabases.length > 0 ? selectedDatabases : null
                };
                
                // Add auth headers if available
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                const token = localStorage.getItem('authToken');
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(searchData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Store search results and redirect to results page
                    sessionStorage.setItem('searchResults', JSON.stringify(data));
                    sessionStorage.setItem('searchQuery', query);
                    sessionStorage.setItem('selectedFilters', JSON.stringify(Array.from(selectedFilters)));
                    
                    window.location.href = '/results';
                } else {
                    throw new Error(data.error || 'Search failed');
                }
            } catch (error) {
                console.error('Search error:', error);
                showTemporaryMessage('Search failed: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Handle Enter key in search input
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        
        // Authentication functions
        function checkAuthenticationStatus() {
            const token = localStorage.getItem('authToken');
            const userData = localStorage.getItem('userData');
            const userMode = localStorage.getItem('userMode');
            
            if (token && userData && userMode === 'authenticated') {
                // Verify token is still valid
                fetch('/api/auth/verify', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showUserInfo(JSON.parse(userData));
                        loadUserThemePreference();
                    } else {
                        showLoginButtons();
                    }
                })
                .catch(error => {
                    console.error('Error verifying token:', error);
                    showLoginButtons();
                });
            } else {
                showLoginButtons();
            }
        }
        
        function showLoginButtons() {
            const authButtons = document.getElementById('authButtons');
            const userInfo = document.getElementById('userInfo');
            
            if (authButtons && userInfo) {
                authButtons.style.display = 'flex';
                userInfo.style.display = 'none';
            }
        }
        
        function showUserInfo(userData) {
            try {
                const authButtons = document.getElementById('authButtons');
                const userInfo = document.getElementById('userInfo');
                const userProfile = document.getElementById('userProfile');
                
                if (!authButtons || !userInfo || !userProfile) {
                    console.error('Required DOM elements not found for user info');
                    return;
                }
                
                authButtons.style.display = 'none';
                userInfo.style.display = 'flex';
                
                const firstName = userData.profile?.first_name || '';
                const lastName = userData.profile?.last_name || '';
                const fullName = `${firstName} ${lastName}`.trim() || userData.username || 'User';
                const initials = fullName.split(' ').map(n => n[0]).join('').toUpperCase();
                
                userProfile.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <a href="/dashboard" class="flex items-center space-x-2 hover:bg-white hover:bg-opacity-10 px-3 py-2 rounded-lg transition-colors">
                            <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-white text-sm font-medium">
                                ${initials}
                            </div>
                            <span class="text-sm font-medium text-white">${fullName}</span>
                        </a>
                        <button onclick="logout()" class="text-xs text-blue-200 hover:text-white transition-colors">
                            Logout
                        </button>
                    </div>
                `;
            } catch (error) {
                console.error('Error in showUserInfo:', error);
                showLoginButtons();
            }
        }
        
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userData');
            localStorage.removeItem('userMode');
            showLoginButtons();
            showTemporaryMessage('Logged out successfully', 'success');
        }
        
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initializeTheme();
                checkAuthenticationStatus();
            } catch (error) {
                console.error('Error in initialization:', error);
                showLoginButtons();
            }
        });
    </script>
</body>
</html> 